<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ההתקדמות שלי | פלטפורמת למידה במתמטיקה</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Assistant', sans-serif; 
        }
        /* Styles for printing: hide unnecessary elements */
        @media print {
            body * {
                visibility: hidden;
            }
            #print-area, #print-area * {
                visibility: visible;
            }
            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none !important;
            }
        }
        #notification-box {
            transition: opacity 0.5s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="notification-box" class="fixed top-5 right-5 text-white p-4 rounded-lg shadow-xl hidden z-50 max-w-sm text-right">
        הודעה תוצג כאן
    </div>

    <div class="container mx-auto p-4 md:p-8">
        <header class="mb-8 no-print">
            <nav aria-label="breadcrumb" class="text-sm text-gray-600 mb-2">
                <ol class="list-none p-0 inline-flex">
                    <li class="flex items-center">
                        <a href="lessonchoicemenue.html" class="hover:underline">דף ראשי</a> <svg class="fill-current w-3 h-3 mx-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path d="M285.476 272.971L91.132 467.314c-9.373 9.373-24.569 9.373-33.941 0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941 0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>
                    </li>
                    <li class="flex items-center">
                        <span class="text-gray-500">ההתקדמות שלי</span>
                    </li>
                </ol>
            </nav>
            <h1 class="text-3xl md:text-4xl font-bold text-blue-700">לוח התקדמות אישי</h1>
        </header>

        <div id="print-area">
            <main class="bg-white p-6 md:p-8 rounded-lg shadow-lg">
                <section id="summary" aria-labelledby="summary-heading" class="mb-10">
                    <h2 id="summary-heading" class="text-2xl font-semibold text-blue-600 mb-4 border-b-2 border-blue-200 pb-2">סיכום התקדמות</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-blue-50 p-6 rounded-lg shadow">
                            <h3 class="text-lg font-medium text-blue-800">שיעורים שהושלמו</h3>
                            <p id="total-lessons-completed" class="text-3xl font-bold text-blue-600 mt-2">0</p>
                        </div>
                        <div class="bg-green-50 p-6 rounded-lg shadow">
                            <h3 class="text-lg font-medium text-green-800">ממוצע ציוני בחנים</h3>
                            <p id="average-quiz-score" class="text-3xl font-bold text-green-600 mt-2">לא זמין</p>
                        </div>
                    </div>
                </section>

                <section id="completed-lessons" aria-labelledby="completed-lessons-heading" class="mb-10">
                    <h2 id="completed-lessons-heading" class="text-2xl font-semibold text-blue-600 mb-4 border-b-2 border-blue-200 pb-2">שיעורים שהושלמו ✅</h2>
                    <div id="completed-lessons-list" class="space-y-3">
                        <p class="text-gray-500">עדיין לא השלמת שיעורים.</p>
                         </div>
                </section>

                <section id="quiz-scores" aria-labelledby="quiz-scores-heading" class="mb-10">
                    <h2 id="quiz-scores-heading" class="text-2xl font-semibold text-blue-600 mb-4 border-b-2 border-blue-200 pb-2">ציוני בחנים 🎯</h2>
                    <div class="overflow-x-auto">
                        <table id="quiz-scores-table" class="min-w-full bg-white border border-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="py-3 px-4 border-b text-right font-semibold text-gray-600">שם שיעור</th>
                                    <th class="py-3 px-4 border-b text-right font-semibold text-gray-600">ציון</th>
                                    <th class="py-3 px-4 border-b text-right font-semibold text-gray-600">תאריך</th>
                                </tr>
                            </thead>
                            <tbody id="quiz-scores-tbody">
                                <tr><td colspan="3" class="text-center py-4 text-gray-500">עדיין אין ציוני בחנים.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </section>
            </main>
        </div> 
        <section id="export-options" class="mt-8 mb-12 text-center no-print">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">אפשרויות ייצוא</h2>
            <div class="space-x-0 md:space-x-4 space-y-4 md:space-y-0 rtl:space-x-reverse">
                <button id="export-pdf" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-6 rounded-md transition duration-150 ease-in-out">
                    ייצא כ-PDF 📄
                </button>
                <button id="export-csv" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-6 rounded-md transition duration-150 ease-in-out">
                    ייצא כ-CSV 📊
                </button>
            </div>
        </section>
        
        <footer class="text-center text-gray-600 mt-12 py-4 border-t border-gray-300 no-print">
            <p>&copy; <span id="current-year"></span> פלטפורמת למידה במתמטיקה. כל הזכויות שמורות.</p>
        </footer>
    </div>

    <script>
        // --- Notification Box Logic ---
        function showNotification(message, type = 'info', duration = 3000) {
            const notificationBox = document.getElementById('notification-box');
            if (!notificationBox) return;
            notificationBox.textContent = message;
            notificationBox.className = 'fixed top-5 right-5 text-white p-4 rounded-lg shadow-xl z-50 max-w-sm text-right'; 
            if (type === 'success') notificationBox.classList.add('bg-green-500');
            else if (type === 'error') notificationBox.classList.add('bg-red-500');
            else notificationBox.classList.add('bg-blue-500');
            notificationBox.classList.remove('hidden');
            notificationBox.style.opacity = 1;
            setTimeout(() => {
                notificationBox.style.opacity = 0;
                setTimeout(() => { notificationBox.classList.add('hidden'); }, 500);
            }, duration);
        }

        // --- Lesson ID to Display Name Mapping ---
        // This map MUST be kept up-to-date with all lesson IDs and their user-friendly names.
        const lessonDisplayNames = {
            // Shalon 35182
            '35182_algebra_linear_equation_one_variable': 'אלגברה (35182): משוואה ממעלה ראשונה עם נעלם אחד',
            '35182_algebra_linear_equations_two_variables': 'אלגברה (35182): מערכת משוואות בשני נעלמים',
            '35182_algebra_quadratic_equations': 'אלגברה (35182): משוואות ריבועיות',
            '35182_algebra_inequalities': 'אלגברה (35182): אי-שוויונות',
            '35182_algebra_percentages': 'אלגברה (35182): אחוזים',
            '35182_algebra_word_problems': 'אלגברה (35182): בעיות מילוליות',
            '35182_geometry_shapes_properties': 'גיאומטריה (35182): תכונות צורות',
            '35182_geometry_area_perimeter': 'גיאומטריה (35182): שטח והיקף',
            '35182_analytic_geometry_points': 'גיאומטריה אנליטית (35182): נקודות',
            '35182_analytic_geometry_distance': 'גיאומטריה אנליטית (35182): מרחק',
            '35182_analytic_geometry_midpoint': 'גיאומטריה אנליטית (35182): אמצע קטע',
            '35182_analytic_geometry_slope_line_equation': 'גיאומטריה אנליטית (35182): שיפוע ומשוואת הישר',
            '35182_sequences_arithmetic_intro': 'סדרות (35182): סדרה חשבונית - מבוא',
            '35182_trigonometry_right_triangle': 'טריגונומטריה (35182): משולש ישר זווית',
            '35182_statistics_intro': 'סטטיסטיקה (35182): מבוא',
            '35182_probability_intro': 'הסתברות (35182): מבוא',
            
            // Shalon 35381
            '35381_functions_parabola_investigation': 'פונקציות (35381): חקירת פונקציה ריבועית (פרבולה)',
            '35381_sequences_arithmetic_sum': 'סדרות (35381): סכום סדרה חשבונית',
            '35381_growth_decay': 'פונקציות (35381): גדילה ודעיכה',
            '35381_statistics_dispersion': 'סטטיסטיקה (35381): מדדי פיזור',
            '35381_probability_tree_conditional': 'הסתברות (35381): דיאגרמת עץ והסתברות מותנית',
            '35381_normal_distribution': 'סטטיסטיקה (35381): התפלגות נורמלית',
            '35381_trigonometry_plane': 'טריגונומטריה (35381): טריגונומטריה במישור (המשך)',
            
            // Shalon 35382
            'lesson_35382_problems_buy_sell': 'בעיות מילוליות (35382): בעיות קנייה ומכירה', // Corrected ID prefix
            'lesson_35382_problems_motion': 'בעיות מילוליות (35382): בעיות תנועה',
            'lesson_35382_problems_work_rate': 'בעיות מילוליות (35382): בעיות הספק',
            'lesson_35382_problems_geometric_algebraic': 'בעיות מילוליות (35382): בעיות גיאומטריות-אלגבריות',
            'lesson_35382_analytic_geometry_line_continued': 'גיאומטריה אנליטית (35382): הישר (המשך)',
            'lesson_35382_analytic_geometry_circle': 'גיאומטריה אנליטית (35382): המעגל',
            'lesson_35382_analytic_geometry_circle_tangent': 'גיאומטריה אנליטית (35382): משיק למעגל',
            'lesson_35382_analytic_geometry_circle_line_intersection': 'גיאומטריה אנליטית (35382): חיתוך של מעגל וישר',
            'lesson_35382_calculus_polynomial': 'חדו"א (35382): פונקציית פולינום',
            'lesson_35382_calculus_rational': 'חדו"א (35382): פונקציה רציונלית',
            'lesson_35382_calculus_square_root': 'חדו"א (35382): פונקציית שורש',
            'lesson_35382_calculus_optimization': 'חדו"א (35382): בעיות קיצון',
            'lesson_35382_calculus_integral_polynomial': 'חדו"א (35382): חשבון אינטגרלי (פולינומים)'
        };

        function formatLessonIdForDisplay(lessonIdKey) {
            // Remove prefixes like 'lesson_completed_' or 'lesson_quiz_score_'
            const idPart = lessonIdKey.replace(/^lesson_completed_|^lesson_quiz_score_/, '');
            return lessonDisplayNames[idPart] || idPart.replace(/_/g, ' ').replace(/^lesson /,''); // Fallback
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('current-year').textContent = new Date().getFullYear();
            loadProgressData();
            const exportPdfButton = document.getElementById('export-pdf');
            if (exportPdfButton) exportPdfButton.addEventListener('click', exportToPdf);
            const exportCsvButton = document.getElementById('export-csv');
            if (exportCsvButton) exportCsvButton.addEventListener('click', exportToCsv);
        });

        function loadProgressData() {
            const completedLessonsList = document.getElementById('completed-lessons-list');
            const quizScoresTbody = document.getElementById('quiz-scores-tbody');
            const totalLessonsCompletedEl = document.getElementById('total-lessons-completed');
            const averageQuizScoreEl = document.getElementById('average-quiz-score');

            let completedLessons = [];
            let quizScores = [];

            try {
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith('lesson_completed_')) {
                        const lessonName = formatLessonIdForDisplay(key);
                        completedLessons.push(lessonName);
                    } else if (key.startsWith('lesson_quiz_score_')) {
                        const lessonName = formatLessonIdForDisplay(key);
                        const scoreDataString = localStorage.getItem(key);
                        if (scoreDataString) {
                            const scoreData = JSON.parse(scoreDataString);
                            quizScores.push({ 
                                name: lessonName, 
                                score: scoreData.score, 
                                total: scoreData.total, 
                                date: new Date(scoreData.date).toLocaleDateString('he-IL')
                            });
                        }
                    }
                }
            } catch (e) {
                console.error("Error reading from localStorage:", e);
                showNotification("שגיאה בקריאת נתוני התקדמות.", "error");
                if(completedLessonsList) completedLessonsList.innerHTML = '<p class="text-red-500">שגיאה בטעינת שיעורים שהושלמו.</p>';
                if(quizScoresTbody) quizScoresTbody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-red-500">שגיאה בטעינת ציוני בחנים.</td></tr>';
                return;
            }

            // Populate Completed Lessons
            if (completedLessonsList) {
                if (completedLessons.length > 0) {
                    completedLessonsList.innerHTML = ''; 
                    completedLessons.sort((a,b) => a.localeCompare(b, 'he')); 
                    completedLessons.forEach(lessonName => {
                        const lessonEl = document.createElement('div');
                        lessonEl.className = 'bg-gray-100 p-3 rounded-md shadow-sm flex items-center';
                        lessonEl.innerHTML = `<span class="text-green-500 mr-2 ml-2">✔</span> ${lessonName}`;
                        completedLessonsList.appendChild(lessonEl);
                    });
                } else {
                    completedLessonsList.innerHTML = '<p class="text-gray-500">עדיין לא השלמת שיעורים.</p>';
                }
            }
            if(totalLessonsCompletedEl) totalLessonsCompletedEl.textContent = completedLessons.length;

            // Populate Quiz Scores
            if (quizScoresTbody) {
                if (quizScores.length > 0) {
                    quizScoresTbody.innerHTML = ''; 
                    let totalScoreSum = 0;
                    let totalPossibleSum = 0;
                    quizScores.sort((a, b) => a.name.localeCompare(b.name, 'he')); 

                    quizScores.forEach(quiz => {
                        const row = quizScoresTbody.insertRow();
                        row.className = 'hover:bg-gray-50 transition-colors duration-150';
                        
                        const cellName = row.insertCell();
                        cellName.className = 'py-3 px-4 border-b text-right';
                        cellName.textContent = quiz.name;

                        const cellScore = row.insertCell();
                        cellScore.className = 'py-3 px-4 border-b text-right';
                        cellScore.textContent = `${quiz.score} / ${quiz.total}`;
                        
                        const cellDate = row.insertCell();
                        cellDate.className = 'py-3 px-4 border-b text-right';
                        cellDate.textContent = quiz.date;

                        if (typeof quiz.score === 'number' && typeof quiz.total === 'number' && quiz.total > 0) {
                            totalScoreSum += quiz.score;
                            totalPossibleSum += quiz.total;
                        }
                    });

                    if (averageQuizScoreEl) {
                        if (totalPossibleSum > 0) {
                            const average = (totalScoreSum / totalPossibleSum) * 100;
                            averageQuizScoreEl.textContent = `${average.toFixed(1)}%`;
                        } else {
                            averageQuizScoreEl.textContent = 'לא זמין';
                        }
                    }

                } else {
                    quizScoresTbody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">עדיין אין ציוני בחנים.</td></tr>';
                    if(averageQuizScoreEl) averageQuizScoreEl.textContent = 'לא זמין';
                }
            }
        }

        function exportToPdf() {
            showNotification('מכין PDF להדפסה...', 'info', 2000);
            setTimeout(() => { window.print(); }, 500);
        }

        function getProgressDataForExport() {
            let completedLessons = [];
            let quizScoresData = [];
            try {
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith('lesson_completed_')) {
                        completedLessons.push(formatLessonIdForDisplay(key));
                    } else if (key.startsWith('lesson_quiz_score_')) {
                         const scoreDataString = localStorage.getItem(key);
                        if (scoreDataString) {
                            const scoreData = JSON.parse(scoreDataString);
                            quizScoresData.push({
                                name: formatLessonIdForDisplay(key),
                                score: scoreData.score,
                                total: scoreData.total,
                                date: new Date(scoreData.date).toLocaleDateString('he-IL')
                            });
                        }
                    }
                }
            } catch (e) {
                console.error("Error reading from localStorage for export:", e);
                showNotification("שגיאה באיסוף נתונים לייצוא.", "error");
                return null;
            }
            completedLessons.sort((a,b) => a.localeCompare(b, 'he'));
            quizScoresData.sort((a, b) => a.name.localeCompare(b.name, 'he'));
            return { completedLessons, quizScoresData };
        }

        function exportToCsv() {
            const data = getProgressDataForExport();
            if (!data) return;

            const { completedLessons, quizScoresData } = data;
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "\uFEFF"; // BOM for UTF-8 Excel compatibility

            csvContent += "סוג,פרט,ציון,סך הכל שאלות,תאריך\r\n";

            completedLessons.forEach(lessonName => {
                csvContent += `שיעור הושלם,"${lessonName.replace(/"/g, '""')}",,, \r\n`;
            });

            quizScoresData.forEach(quiz => {
                csvContent += `ציון בוחן,"${quiz.name.replace(/"/g, '""')}",${quiz.score},${quiz.total},${quiz.date}\r\n`;
            });
            
            if (completedLessons.length === 0 && quizScoresData.length === 0) {
                showNotification('אין נתונים לייצוא.', 'info');
                return;
            }

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "math_progress_report.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showNotification('דוח CSV ירד בהצלחה!', 'success');
        }
    </script>
</body>
</html>
