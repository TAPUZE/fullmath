<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>הסתברות (המשך) - דיאגרמת עץ והסתברות מותנית | פלטפורמת למידה במתמטיקה</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" xintegrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" xintegrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUbKyJZo8" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" xintegrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Assistant', sans-serif;
        }
        .formula-box {
            background-color: #E5E7EB; /* bg-gray-200 */
            padding: 0.75rem; 
            border-radius: 0.375rem; /* rounded-md */
            display: inline-block; 
            font-size: 1.125em; /* text-lg */
            line-height: 1.5; 
            margin-top: 0.25rem;
            margin-bottom: 0.25rem;
        }
        .formula-box[dir="ltr"] .katex {
            text-align: left !important;
        }
        #notification-box {
            transition: opacity 0.5s ease-in-out;
        }
        .solution {
            background-color: #f3f4f6; 
            border: 1px solid #d1d5db; 
        }
        .feedback.bg-green-100 { border: 1px solid #a7f3d0; }
        .feedback.bg-red-100 { border: 1px solid #fecaca; }
        .feedback.bg-yellow-100 { border: 1px solid #fde68a; }
        .katex-display > .katex { text-align: center; }

        /* Styles for Tree Diagram SVG */
        .tree-diagram-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 1.5rem 0;
            padding: 1rem;
            background-color: #f9fafb; /* bg-gray-50 */
            border: 1px solid #e5e7eb; /* border-gray-200 */
            border-radius: 0.5rem; /* rounded-lg */
        }
        .tree-diagram text {
            font-family: 'Assistant', sans-serif;
            font-size: 12px;
            fill: #374151; /* text-gray-700 */
        }
        .tree-diagram .branch-label {
            font-size: 11px;
            fill: #1d4ed8; /* text-blue-700 */
        }
        .tree-diagram .outcome-label {
            font-size: 13px;
            font-weight: 600;
            fill: #059669; /* text-green-600 */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

<div id="notification-box" class="fixed top-5 right-5 text-white p-4 rounded-lg shadow-xl hidden z-50 max-w-sm text-right">
הודעה תוצג כאן
</div>

<div class="container mx-auto p-4 md:p-8 max-w-5xl">
<header class="mb-8">
<nav aria-label="breadcrumb" class="text-sm text-gray-600 mb-2">
<ol class="list-none p-0 inline-flex">
<li class="flex items-center">
            <a href="math_platform_main_page_he.html" class="hover:underline">דף ראשי</a>
<svg class="fill-current w-3 h-3 mx-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path d="M285.476 272.971L91.132 467.314c-9.373 9.373-24.569 9.373-33.941 0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569 9.373 33.941 0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>
</li>
<li class="flex items-center">
<a href="questionnaire_35381_lessons_page_he.html" id="breadcrumb-questionnaire" class="hover:underline">שאלון 35381</a>
<svg class="fill-current w-3 h-3 mx-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path d="M285.476 272.971L91.132 467.314c-9.373 9.373-24.569 9.373-33.941 0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569 9.373 33.941 0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>
</li>
<li class="flex items-center">
<span id="breadcrumb-main-topic" class="text-gray-700">הסתברות</span>
            <svg class="fill-current w-3 h-3 mx-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path d="M285.476 272.971L91.132 467.314c-9.373 9.373-24.569 9.373-33.941 0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569 9.373 33.941 0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>
</li>
<li class="flex items-center">
<span id="breadcrumb-lesson-name" class="text-gray-500">דיאגרמת עץ והסתברות מותנית</span>
</li>
</ol>
</nav>
<h1 id="lesson-title" class="text-3xl md:text-4xl font-bold text-green-700">הסתברות (המשך) - דיאגרמת עץ והסתברות מותנית</h1>
</header>

<main class="bg-white p-6 md:p-8 rounded-lg shadow-lg">

    <section id="learn" aria-labelledby="learn-heading" class="mb-12">
        <h2 id="learn-heading" class="text-2xl font-semibold text-green-600 mb-4 border-b-2 border-green-200 pb-2">לומדים 📚</h2>
        <div class="space-y-4 text-gray-700 leading-relaxed">
            <p>כאשר אנו עוסקים בניסויים המורכבים ממספר שלבים (ניסויים רב-שלביים), דיאגרמת עץ היא כלי ויזואלי יעיל מאוד לתיאור כל התוצאות האפשריות ולחישוב ההסתברויות שלהן.</p>
            
            <h3 class="text-xl font-semibold mt-6 mb-2 text-gray-800">1. מהי דיאגרמת עץ?</h3>
            <p>דיאגרמת עץ מורכבת מ"ענפים" המייצגים את התוצאות האפשריות בכל שלב של הניסוי. על כל ענף רושמים את ההסתברות של אותה תוצאה.</p>
            <ul class="list-disc pr-6 space-y-1">
                <li>הדיאגרמה מתחילה מנקודה אחת (ה"שורש").</li>
                <li>מנקודה זו יוצאים ענפים כמספר התוצאות האפשריות בשלב הראשון של הניסוי.</li>
                <li>מכל קצה של ענף מהשלב הראשון, יוצאים ענפים נוספים כמספר התוצאות האפשריות בשלב השני, וכן הלאה.</li>
                <li>סכום ההסתברויות על כל הענפים היוצאים מאותה נקודה (צומת) חייב להיות 1.</li>
            </ul>

            <h3 class="text-xl font-semibold mt-6 mb-2 text-gray-800">2. חישוב הסתברויות באמצעות דיאגרמת עץ</h3>
            <ul class="list-disc pr-6 space-y-1">
                <li><strong>הסתברות של מסלול מסוים (מאורע "וגם"):</strong> כדי לחשב את ההסתברות של רצף מסוים של תוצאות (מסלול מהשורש עד לקצה ענף סופי), מכפילים את ההסתברויות הרשומות על כל הענפים לאורך אותו מסלול.</li>
                <li><strong>הסתברות של מאורע המורכב ממספר מסלולים (מאורע "או"):</strong> אם מאורע מסוים יכול להתקבל באמצעות מספר מסלולים שונים בדיאגרמה, מחשבים את ההסתברות של כל מסלול בנפרד (על ידי כפל, כפי שתואר לעיל), ולאחר מכן מחברים את ההסתברויות של כל המסלולים הרלוונטיים.</li>
            </ul>
            <p class="text-sm text-gray-600">חשוב לשים לב: המיקוד לשנת תשפ"ה הסיר את הנושא "הסתברות של מאורעות תלויים (הוצאה בלי החזרה)" באופן גורף. לכן, רוב השאלות יתמקדו בהוצאה עם החזרה, או בתרחישים בהם ההסתברויות בכל שלב אינן משתנות באופן מורכב מדי.</p>

            <h3 class="text-xl font-semibold mt-6 mb-2 text-gray-800">3. הסתברות מותנית (ברמה בסיסית)</h3>
            <p>הסתברות מותנית היא ההסתברות שמאורע A יתרחש, בהינתן שמאורע B כבר התרחש. היא מסומנת <span class="formula-box" dir="ltr">\(P(A|B)\)</span> (קרי: ההסתברות של A בתנאי B).</p>
            <p>במקרים פשוטים, ניתן לחשב הסתברות מותנית ישירות מדיאגרמת עץ או מטבלה דו-ממדית (כפי שנראה בדוגמאות).</p>
            <p>הנוסחה הכללית להסתברות מותנית (שחשוב להכיר גם אם לא תמיד נשתמש בה ישירות לחישוב ברמה זו):</p>
            <div class="my-2 text-center">
                <span class="formula-box" dir="ltr">\(P(A|B) = \frac{P(A \cap B)}{P(B)}\)</span>
            </div>
            <p>כאשר <span class="formula-box" dir="ltr">\(P(A \cap B)\)</span> היא ההסתברות שגם A וגם B יתרחשו (חיתוך המאורעות).</p>

            <h3 class="text-xl font-semibold mt-8 mb-2 text-gray-800">דוגמה פתורה: הטלת מטבע פעמיים</h3>
            <div class="border border-gray-200 rounded-lg p-4 bg-gray-50 space-y-3 mb-6">
                <p class="font-medium"><strong>דוגמה:</strong> מטילים מטבע הוגן פעמיים. ("עץ" - ע, "פלי" - פ)</p>
                <p>א. שרטט דיאגרמת עץ המתארת את הניסוי.</p>
                <p>ב. מה ההסתברות לקבל "עץ" בשתי ההטלות?</p>
                <p>ג. מה ההסתברות לקבל בדיוק "עץ" אחד?</p>
                <p>ד. מה ההסתברות לקבל "עץ" בהטלה השנייה, אם ידוע שבהטלה הראשונה התקבל "פלי"?</p>

                <p><strong>פתרון:</strong></p>
                <p>א. דיאגרמת עץ:</p>
                <div class="tree-diagram-container">
                    <svg width="300" height="200" class="tree-diagram">
                        <circle cx="30" cy="100" r="3" fill="black"/>
                        <line x1="30" y1="100" x2="100" y2="50" stroke="black"/>
                        <text x="60" y="70" class="branch-label">0.5 (ע)</text>
                        <circle cx="100" cy="50" r="3" fill="black"/>
                        <line x1="30" y1="100" x2="100" y2="150" stroke="black"/>
                        <text x="60" y="130" class="branch-label">0.5 (פ)</text>
                        <circle cx="100" cy="150" r="3" fill="black"/>
                        <line x1="100" y1="50" x2="170" y2="25" stroke="black"/>
                        <text x="130" y="32" class="branch-label">0.5 (ע)</text>
                        <text x="185" y="28" class="outcome-label">עע (0.25)</text>
                        <line x1="100" y1="50" x2="170" y2="75" stroke="black"/>
                        <text x="130" y="68" class="branch-label">0.5 (פ)</text>
                        <text x="185" y="78" class="outcome-label">עפ (0.25)</text>
                        <line x1="100" y1="150" x2="170" y2="125" stroke="black"/>
                        <text x="130" y="132" class="branch-label">0.5 (ע)</text>
                        <text x="185" y="128" class="outcome-label">פע (0.25)</text>
                        <line x1="100" y1="150" x2="170" y2="175" stroke="black"/>
                        <text x="130" y="168" class="branch-label">0.5 (פ)</text>
                        <text x="185" y="178" class="outcome-label">פפ (0.25)</text>
                    </svg>
                </div>
                <p>ב. הסתברות לקבל "עץ" בשתי ההטלות (מסלול ע-ע):</p>
                <div class="my-2 text-center"><span class="formula-box" dir="ltr">\(P(\text{עע}) = 0.5 \cdot 0.5 = 0.25\)</span></div>
                <p>ג. הסתברות לקבל בדיוק "עץ" אחד (מסלולים ע-פ או פ-ע):</p>
                <div class="my-2 text-center"><span class="formula-box" dir="ltr">\(P(\text{עפ}) = 0.5 \cdot 0.5 = 0.25\)</span></div>
                <div class="my-2 text-center"><span class="formula-box" dir="ltr">\(P(\text{פע}) = 0.5 \cdot 0.5 = 0.25\)</span></div>
                <div class="my-2 text-center"><span class="formula-box" dir="ltr">\(P(\text{בדיוק עץ אחד}) = P(\text{עפ}) + P(\text{פע}) = 0.25 + 0.25 = 0.5\)</span></div>
                <p>ד. הסתברות לקבל "עץ" בהטלה השנייה, אם ידוע שבהטלה הראשונה התקבל "פלי":</p>
                <p>במקרה זה, אנו מסתכלים רק על הענפים שיוצאים מהתוצאה "פלי" בהטלה הראשונה. ההסתברות לקבל "עץ" בשלב זה היא ההסתברות הרשומה על הענף המתאים:</p>
                 <div class="my-2 text-center"><span class="formula-box" dir="ltr">\(P(\text{עץ שני | פלי ראשון}) = 0.5\)</span></div>
            </div>
        </div>
    </section>

    <section id="practice" aria-labelledby="practice-heading" class="mb-12">
        <h2 id="practice-heading" class="text-2xl font-semibold text-green-600 mb-4 border-b-2 border-green-200 pb-2">מתרגלים ✍️</h2>
        <div class="space-y-6">
            <div class="exercise p-4 border border-gray-300 rounded-lg bg-gray-50">
                <p class="exercise-question font-medium"><strong>תרגיל 1:</strong> בכד 3 כדורים אדומים ו-2 כדורים כחולים. מוציאים באקראי כדור אחד, רושמים את צבעו ומחזירים אותו לכד. לאחר מכן, מוציאים באקראי כדור נוסף. מה ההסתברות שבשתי הפעמים הוצא כדור אדום?</p>
                <div class="mt-3">
                    <input type="text" id="ex1-answer" class="border border-gray-300 p-2 rounded w-full md:w-1/2 focus:ring-green-500 focus:border-green-500" placeholder="הכנס תשובה (כשבר פשוט או עשרוני)">
                </div>
                <div class="mt-3">
                    <button onclick="checkAnswer('ex1', '9/25', false, 0.001, true)" class="check-answer-btn bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-md transition duration-150 ease-in-out">בדוק תשובה</button>
                    <button onclick="showSolution('sol1')" class="show-solution-btn bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-md transition duration-150 ease-in-out ml-2">הצג פתרון</button>
                </div>
                <div id="feedback-ex1" class="feedback hidden mt-3 p-3 rounded-md text-sm"></div>
                <div id="sol1" class="solution hidden mt-3 p-3 border-t border-gray-200 bg-white rounded-md">
                    <p><strong>פתרון מלא:</strong></p>
                    <p>סה"כ כדורים בכד: 3 (אדומים) + 2 (כחולים) = 5 כדורים.</p>
                    <p>הסתברות להוציא כדור אדום בהוצאה ראשונה: <span class="formula-box" dir="ltr">\(P(\text{אדום}_1) = \frac{3}{5}\)</span>.</p>
                    <p>מכיוון שמחזירים את הכדור, ההסתברות להוציא כדור אדום בהוצאה שנייה זהה: <span class="formula-box" dir="ltr">\(P(\text{אדום}_2) = \frac{3}{5}\)</span>.</p>
                    <p>ההסתברות להוציא אדום בשתי הפעמים (מאורעות בלתי תלויים):</p>
                    <p><span class="formula-box" dir="ltr">\(P(\text{אדום}_1 \text{ וגם אדום}_2) = P(\text{אדום}_1) \cdot P(\text{אדום}_2) = \frac{3}{5} \cdot \frac{3}{5} = \frac{9}{25}\)</span> (או 0.36).</p>
                </div>
            </div>
        </div>
    </section>

    <section id="test-yourself" aria-labelledby="test-heading" class="mb-12">
        <h2 id="test-heading" class="text-2xl font-semibold text-green-600 mb-4 border-b-2 border-green-200 pb-2">בחן את עצמך 🧐</h2>
        <form id="quizForm" class="space-y-6">
            <div class="quiz-question p-4 border border-gray-300 rounded-lg bg-gray-50">
                <p class="font-medium"><strong>שאלה 1:</strong> מטילים קובייה הוגנת פעמיים. מה ההסתברות שבשתי ההטלות יתקבל המספר 6?</p>
                <div class="mt-2 space-y-1">
                    <label class="flex items-center"><input type="radio" name="q1" value="a" class="form-radio text-green-600 ml-2"> <span dir="ltr">\(1/6\)</span></label>
                    <label class="flex items-center"><input type="radio" name="q1" value="b" class="form-radio text-green-600 ml-2"> <span dir="ltr">\(1/12\)</span></label>
                    <label class="flex items-center"><input type="radio" name="q1" value="c" class="form-radio text-green-600 ml-2"> <span dir="ltr">\(1/36\)</span></label>
                </div>
            </div>
            <div class="quiz-question p-4 border border-gray-300 rounded-lg bg-gray-50">
                <p class="font-medium"><strong>שאלה 2:</strong> בשק 4 כדורים אדומים ו-6 כדורים ירוקים. מוציאים כדור, מחזירים אותו, ומוציאים כדור נוסף. מה ההסתברות שהכדור הראשון אדום והשני ירוק?</p>
                 <div class="mt-2 space-y-1">
                    <label class="flex items-center"><input type="radio" name="q2" value="a" class="form-radio text-green-600 ml-2"> <span dir="ltr">\(24/100\)</span></label>
                    <label class="flex items-center"><input type="radio" name="q2" value="b" class="form-radio text-green-600 ml-2"> <span dir="ltr">\(10/100\)</span></label>
                    <label class="flex items-center"><input type="radio" name="q2" value="c" class="form-radio text-green-600 ml-2"> <span dir="ltr">\(24/90\)</span></label>
                </div>
            </div>
            <button type="button" id="submit-quiz" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md transition duration-150 ease-in-out">הגש בוחן</button>
        </form>
        <div id="quiz-results" class="hidden mt-3 p-3 rounded-md text-sm"></div>
    </section>

    <section id="progress" aria-labelledby="progress-heading" class="text-center mt-12 py-8">
         <button id="mark-completed" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-150 ease-in-out shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50">
            סמן שיעור כהושלם ✅
        </button>
    </section>
</main>

<footer class="text-center text-gray-600 mt-12 py-4 border-t border-gray-300">
    <p>&copy; <span id="current-year"></span> פלטפורמת למידה במתמטיקה. כל הזכויות שמורות.</p>
</footer>
</div>

<script>
const LESSON_ID = '35381_probability_tree_conditional';
const LESSON_TITLE = 'הסתברות (המשך) - דיאגרמת עץ והסתברות מותנית';
const BREADCRUMB_QUESTIONNAIRE_TEXT = 'שאלון 35381';
const BREADCRUMB_QUESTIONNAIRE_LINK = 'questionnaire_35381_lessons_page_he.html';
const BREADCRUMB_MAIN_TOPIC_TEXT = 'הסתברות';

const QUIZ_ANSWERS = { q1: 'c', q2: 'a' }; 
// Q1: P(6 and 6) = (1/6) * (1/6) = 1/36
// Q2: P(Red then Green) = P(Red) * P(Green) = (4/10) * (6/10) = 24/100

document.addEventListener("DOMContentLoaded", function() {
    // Call the local renderMathInElement function to render math in the body
    renderMathInElement(document.body); 
    
    document.getElementById('lesson-title').textContent = LESSON_TITLE;
    document.title = LESSON_TITLE + " | פלטפורמת למידה במתמטיקה";
    
    const breadcrumbQ = document.getElementById('breadcrumb-questionnaire');
    breadcrumbQ.textContent = BREADCRUMB_QUESTIONNAIRE_TEXT;
    breadcrumbQ.href = BREADCRUMB_QUESTIONNAIRE_LINK;
    
    document.getElementById('breadcrumb-main-topic').textContent = BREADCRUMB_MAIN_TOPIC_TEXT; 
    document.getElementById('breadcrumb-lesson-name').textContent = "דיאגרמת עץ והסתברות מותנית";
    document.getElementById('current-year').textContent = new Date().getFullYear();
    checkLessonStatus();
});

function showNotification(message, type = 'info', duration = 3000) {
    const notificationBox = document.getElementById('notification-box');
    if (!notificationBox) return;
    notificationBox.textContent = message;
    notificationBox.className = 'fixed top-5 right-5 text-white p-4 rounded-lg shadow-xl z-50 max-w-sm text-right'; 
    if (type === 'success') notificationBox.classList.add('bg-green-500');
    else if (type === 'error') notificationBox.classList.add('bg-red-500');
    else notificationBox.classList.add('bg-blue-500');
    notificationBox.classList.remove('hidden');
    notificationBox.style.opacity = 1;
    setTimeout(() => {
        notificationBox.style.opacity = 0;
        setTimeout(() => { notificationBox.classList.add('hidden'); }, 500); 
    }, duration);
}

function checkAnswer(exerciseId, correctAnswer, isTuple = false, tolerance = 0.001, isFraction = false) {
    const feedbackEl = document.getElementById(`feedback-${exerciseId}`);
    const userAnswerInput = document.getElementById(`${exerciseId}-answer`);
    let userAnswerStr = userAnswerInput.value.trim();
    let isCorrect = false;

    if (isTuple) {
        userAnswerStr = userAnswerStr.replace(/\s/g, '');
        isCorrect = (userAnswerStr === correctAnswer);
    } else if (isFraction) {
        try {
            // For fractions like "9/25", compare to decimal value or evaluate both
            const evalUser = eval(userAnswerStr.replace(/⁄/g, '/')); // Allow fraction slash
            const evalCorrect = eval(correctAnswer.replace(/⁄/g, '/'));
             if (!isNaN(evalUser) && !isNaN(evalCorrect)) {
                isCorrect = Math.abs(evalUser - evalCorrect) <= tolerance;
            } else {
                 isCorrect = (userAnswerStr === correctAnswer); // Fallback to string if eval fails
            }
        } catch (e) {
            isCorrect = (userAnswerStr === correctAnswer); // Fallback if eval fails
        }
    }
     else {
        const userAnswerNum = parseFloat(userAnswerStr);
        const correctAnswerNum = parseFloat(correctAnswer);
        if (!isNaN(userAnswerNum) && !isNaN(correctAnswerNum)) {
            isCorrect = Math.abs(userAnswerNum - correctAnswerNum) <= tolerance;
        } else { 
            isCorrect = (userAnswerStr === correctAnswer);
        }
    }

    if (isCorrect) {
        feedbackEl.textContent = 'נכון מאוד! כל הכבוד! 👍';
        feedbackEl.className = 'feedback mt-3 p-3 rounded-md text-sm bg-green-100 text-green-700';
    } else {
        feedbackEl.textContent = 'תשובה שגויה. נסה שוב או הצג את הפתרון. 🤔';
        feedbackEl.className = 'feedback mt-3 p-3 rounded-md text-sm bg-red-100 text-red-700';
    }
    feedbackEl.classList.remove('hidden');
}

function showSolution(solutionId) {
    const solutionEl = document.getElementById(solutionId);
    if (solutionEl) {
        solutionEl.classList.toggle('hidden');
        if (!solutionEl.classList.contains('hidden')) {
             // Call the local renderMathInElement to render math in the newly visible solution
             renderMathInElement(solutionEl);
        }
    }
}

const quizSubmitButton = document.getElementById('submit-quiz');
if (quizSubmitButton) {
    quizSubmitButton.addEventListener('click', function() {
        let score = 0;
        const quizForm = document.getElementById('quizForm');
        const totalQuestions = Object.keys(QUIZ_ANSWERS).length;

        for (const questionKey in QUIZ_ANSWERS) {
            const userAnswer = quizForm.elements[questionKey] ? quizForm.elements[questionKey].value : null;
            if (userAnswer === QUIZ_ANSWERS[questionKey]) {
                score++;
            }
        }
        
        const resultsEl = document.getElementById('quiz-results');
        resultsEl.textContent = `הציון שלך הוא: ${score} מתוך ${totalQuestions}.`;
        if (score === totalQuestions) resultsEl.className = 'mt-3 p-3 rounded-md text-sm bg-green-100 text-green-700';
        else if (score > 0) resultsEl.className = 'mt-3 p-3 rounded-md text-sm bg-yellow-100 text-yellow-700';
        else resultsEl.className = 'mt-3 p-3 rounded-md text-sm bg-red-100 text-red-700';
        resultsEl.classList.remove('hidden');
        
        recordQuizScore(score, totalQuestions);
        showNotification(`הבוחן הוגש! ציון: ${score}/${totalQuestions}`, 'info');
    });
}

const markCompletedButton = document.getElementById('mark-completed');
if (markCompletedButton) {
    markCompletedButton.addEventListener('click', function() { markLessonAsCompleted(); });
}

function markLessonAsCompleted() {
    if (!LESSON_ID) { showNotification("שגיאה: לא ניתן היה לזהות את השיעור.", "error"); return; }
    try {
        localStorage.setItem(`lesson_completed_${LESSON_ID}`, 'true');
        showNotification('השיעור סומן כהושלם!', 'success');
        if(markCompletedButton) {
            markCompletedButton.textContent = 'השיעור הושלם 👍';
            markCompletedButton.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
            markCompletedButton.classList.add('bg-green-600', 'cursor-not-allowed');
            markCompletedButton.disabled = true;
        }
    } catch (e) { showNotification("שגיאה בשמירת ההתקדמות.", "error"); }
}

function recordQuizScore(score, totalQuestions) {
    if (!LESSON_ID) return;
    try { localStorage.setItem(`lesson_quiz_score_${LESSON_ID}`, JSON.stringify({score, total: totalQuestions, date: new Date().toISOString()}));
    } catch (e) { console.error("Error saving quiz score to localStorage:", e); }
}

function checkLessonStatus() {
    if (!LESSON_ID) return;
    try {
        const isCompleted = localStorage.getItem(`lesson_completed_${LESSON_ID}`);
        if (isCompleted === 'true' && markCompletedButton) {
            markCompletedButton.textContent = 'השיעור הושלם 👍';
            markCompletedButton.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
            markCompletedButton.classList.add('bg-green-600', 'cursor-not-allowed');
            markCompletedButton.disabled = true;
        }
    } catch (e) { console.error("Error accessing localStorage:", e); }
}

// Local renderMathInElement function to ensure KaTeX is rendered with specific options
function renderMathInElement(element) {
    if (window.renderMathInElement && element) { // Check if global KaTeX function exists
        window.renderMathInElement(element, {
            delimiters: [
                // Corrected typo: right: instead of right\:
                {left: "<span class=\"math-block\">", right: "</span>", display: true},
                {left: "<span class=\"math-inline\">", right: "</span>", display: false},
                {left: "\\(", right: "\\)", display: false}, 
                {left: "\\[", right: "\\]", display: true}
            ],
            throwOnError: false
        });
    }
}
</script>
</body>
</html>
